#!/bin/bash
# Pre-push hook for term-challenge
# Run this before pushing to ensure CI will pass

# Source cargo environment
[ -f "$HOME/.cargo/env" ] && source "$HOME/.cargo/env"

set -e

echo "ðŸ” Running pre-push checks..."
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

check_failed() {
    echo -e "${RED}âŒ $1 FAILED${NC}"
    echo ""
    echo "Push aborted. Fix the issues and try again."
    exit 1
}

check_passed() {
    echo -e "${GREEN}âœ“ $1 passed${NC}"
}

# 1. Format check
echo "ðŸ“ Checking code formatting..."
if ! cargo fmt --check 2>/dev/null; then
    echo -e "${YELLOW}âš ï¸  Code not formatted. Running cargo fmt...${NC}"
    cargo fmt
    echo -e "${YELLOW}Code has been formatted. Please review and commit the changes.${NC}"
    check_failed "Format"
fi
check_passed "Format"

# 2. Build check
echo ""
echo "ðŸ”¨ Checking compilation..."
if ! cargo check --all-targets 2>/dev/null; then
    check_failed "Compilation"
fi
check_passed "Compilation"

# 3. Clippy
echo ""
echo "ðŸ“Ž Running clippy..."
if ! cargo clippy --all-targets --workspace -- -W clippy::all -D warnings \
    -A clippy::too_many_arguments \
    -A clippy::type_complexity \
    -A clippy::large_enum_variant 2>/dev/null; then
    check_failed "Clippy"
fi
check_passed "Clippy"

# 4. Tests
echo ""
echo "ðŸ§ª Running tests..."
if ! cargo test --workspace -- --skip live --skip integration 2>/dev/null; then
    check_failed "Tests"
fi
check_passed "Tests"

echo ""
echo -e "${GREEN}âœ… All pre-push checks passed!${NC}"
echo ""
